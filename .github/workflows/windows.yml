name: Windows Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build (Windows x64)
    runs-on: windows-latest

    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v4
        with:
          path: obs-text-pango

      - name: Checkout Pango Build Toolchain
        uses: actions/checkout@v4
        with:
          repository: kkartaltepe/pango-win32-build
          path: pango-win32-build

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: true
          install: >-
            wget
            patch
            rsync
            tar
            git
            pkg-config
          path-type: inherit

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set up Meson and Ninja
        run: |
          python -m pip install --upgrade pip
          pip install meson ninja

      - name: Cache Pango Toolchain
        id: cache-pango
        uses: actions/cache@v4
        with:
          path: pango-win32-build/install
          key: pango-toolchain-${{ hashFiles('pango-win32-build/download.list', 'pango-win32-build/prepare.sh', 'pango-win32-build/patches/**') }}

      - name: Build Pango Toolchain
        if: steps.cache-pango.outputs.cache-hit != 'true'
        shell: msys2 {0}
        run: |
          cd pango-win32-build
          chmod +x prepare.sh
          ./prepare.sh

      - name: Get OBS Studio Headers
        run: |
          git clone --depth 1 --branch release/32.0 https://github.com/obsproject/obs-studio.git obs-studio

      - name: Build Plugin
        shell: bash
        env:
          PKG_CONFIG_PATH: ${{ github.workspace }}/pango-win32-build/install/lib/pkgconfig
        run: |
          mkdir obs-text-pango/build
          cd obs-text-pango/build

          # Use mixed paths for Windows CMake
          DEPS_DIR=$(cygpath --mixed "${{ github.workspace }}/pango-win32-build/install")
          OBS_DIR=$(cygpath --mixed "${{ github.workspace }}/obs-studio")

          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DOBS_DIR="$OBS_DIR" \
            -DCMAKE_PREFIX_PATH="$DEPS_DIR" \
            -DCMAKE_INSTALL_PREFIX="install"

          ninja
          ninja install

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-text-pango-windows
          path: obs-text-pango/build/install/
