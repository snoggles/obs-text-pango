name: Windows Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build (Windows x64)
    runs-on: windows-latest

    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v4
        with:
          path: obs-text-pango

      - name: Checkout Pango Build Toolchain
        uses: actions/checkout@v4
        with:
          repository: snoggles/pango-win32-build
          path: pango-win32-build

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            pkg-config
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-freetype
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-gettext-runtime
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-libpng
          path-type: inherit

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set up Ninja
        run: |
          python -m pip install --upgrade pip
          pip install ninja

      - name: Get OBS Studio Headers
        run: |
          git clone --depth 1 --branch release/32.0 https://github.com/obsproject/obs-studio.git obs-studio

      - name: Build Plugin
        shell: msys2 {0}
        run: |
          mkdir -p obs-text-pango/build
          cd obs-text-pango/build

          # Use MINGW64 prefix for dependencies
          DEPS_DIR=$(cygpath --mixed "/mingw64")
          OBS_DIR=$(cygpath --mixed "${{ github.workspace }}/obs-studio")

          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DOBS_DIR="$OBS_DIR" \
            -DCMAKE_PREFIX_PATH="$DEPS_DIR" \
            -DCMAKE_INSTALL_PREFIX="install"

          ninja
          ninja install

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-text-pango-windows
          path: obs-text-pango/build/install/
