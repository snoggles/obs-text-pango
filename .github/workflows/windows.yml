name: Windows Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build (Windows x64)
    runs-on: windows-latest

    steps:
      - name: Checkout Plugin
        uses: actions/checkout@v4
        with:
          path: obs-text-pango

      - name: Checkout Pango Build Toolchain
        uses: actions/checkout@v4
        with:
          repository: snoggles/pango-win32-build
          path: pango-win32-build

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-freetype
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-gettext-runtime
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-libpng
          path-type: inherit

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set up Ninja
        run: |
          python -m pip install --upgrade pip
          pip install ninja

      - name: Get OBS Studio Headers
        run: |
          git clone --depth 1 --branch release/32.0 https://github.com/obsproject/obs-studio.git obs-studio

      - name: Cache libobs
        id: cache-libobs
        uses: actions/cache@v4
        with:
          path: obs-install
          key: ${{ runner.os }}-libobs-${{ hashFiles('obs-studio/.git/HEAD') }}

      - name: Build libobs
        if: steps.cache-libobs.outputs.cache-hit != 'true'
        run: |
          cmake -S obs-studio -B obs-studio/build -G "Visual Studio 17 2022" -A x64 `
            -DENABLE_UI=OFF `
            -DENABLE_SCRIPTING=OFF `
            -DENABLE_PLUGINS=OFF `
            -DENABLE_FRONTEND_API=OFF `
            -DENABLE_BROWSER=OFF `
            -DCMAKE_INSTALL_PREFIX=obs-install
          cmake --build obs-studio/build --target libobs --config Release --parallel
          cmake --install obs-studio/build --config Release --component Development

      - name: Build Plugin
        shell: msys2 {0}
        run: |
          mkdir -p obs-text-pango/build
          cd obs-text-pango/build

          # Use MINGW64 prefix for dependencies
          DEPS_DIR=$(cygpath --mixed "/mingw64")
          OBS_DIR=$(cygpath --mixed "${{ github.workspace }}/obs-install")

          # Explicitly set PKG_CONFIG_PATH for MinGW-w64
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"

          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DOBS_DIR="$OBS_DIR" \
            -DCMAKE_PREFIX_PATH="$DEPS_DIR" \
            -DCMAKE_INSTALL_PREFIX="install"

          ninja
          ninja install

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-text-pango-windows
          path: obs-text-pango/build/install/
